<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shubhmovie</title>
    <style>
        :root {
            --primary-color: #00bcd4;
            --secondary-color: #0097a7;
            --background-color: #f0f2f5;
            --card-background: #ffffff;
            --text-color: #333333;
            --light-text-color: #757575;
            --nav-icon-color: #ffffff;
            --border-color: #e0e0e0;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --strong-shadow-color: rgba(0, 0, 0, 0.15);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            margin: 0; padding: 0; background-color: var(--background-color);
            color: var(--text-color); padding-bottom: 70px;
        }

        .page { padding-top: 15px; }
        .main-content { padding: 0 15px; }
        .header { display: flex; align-items: center; padding: 15px 0; overflow-x: auto; }
        .header::-webkit-scrollbar { display: none; }
        .categories { display: flex; gap: 10px; flex-shrink: 0; }
        .category-chip {
            background-color: var(--card-background); color: var(--primary-color); padding: 8px 16px;
            border-radius: 20px; font-size: 14px; cursor: pointer; border: 1px solid var(--border-color);
            white-space: nowrap; box-shadow: 0 2px 4px var(--shadow-color); transition: all 0.2s ease-in-out;
        }
        .category-chip:hover { transform: translateY(-2px); box-shadow: 0 4px 8px var(--strong-shadow-color); }
        .category-chip.active {
            background-color: var(--primary-color); color: white; border-color: var(--primary-color);
            transform: scale(1.05); font-weight: bold;
        }
        .search-section { padding-bottom: 20px; }
        .search-container { display: flex; align-items: center; }
        .search-bar {
            flex-grow: 1; border: 1px solid var(--border-color); background-color: var(--card-background);
            border-radius: 25px; padding: 12px 20px; font-size: 15px; outline: none;
            box-shadow: 0 2px 5px var(--shadow-color); transition: border-color 0.2s;
        }
        .search-bar:focus { border-color: var(--primary-color); }
        .search-button {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            color: white; border: none; border-radius: 50%; width: 45px; height: 45px; margin-left: 10px;
            cursor: pointer; display: flex; justify-content: center; align-items: center; font-size: 22px;
            box-shadow: 0 3px 6px var(--strong-shadow-color); transition: all 0.2s;
        }
        .search-button:active { transform: scale(0.95); box-shadow: 0 1px 3px var(--strong-shadow-color); }
        .media-category { margin-bottom: 25px; animation: fadeIn 0.5s ease-in-out; }
        .category-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .category-title { font-size: 20px; font-weight: bold; }
        .media-scroller { display: flex; overflow-x: auto; gap: 15px; padding: 5px 0 15px 0; min-height: 230px; }
        .media-scroller::-webkit-scrollbar { display: none; }
        .media-card { flex: 0 0 130px; width: 130px; transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; cursor: pointer; perspective: 1000px; }
        .media-card:hover { transform: translateY(-8px); box-shadow: 0 10px 20px var(--strong-shadow-color); }
        .media-card:hover .media-poster { transform: rotateY(5deg); }
        .media-poster { width: 100%; aspect-ratio: 9 / 16; background-color: #e0e0e0; border-radius: 12px; object-fit: cover; border: 1px solid var(--border-color); box-shadow: 0 5px 10px var(--shadow-color); transition: transform 0.3s ease-in-out; }
        .media-title { font-size: 14px; font-weight: 500; margin-top: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-right: 5px; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 60px; background-color: var(--card-background); display: flex; justify-content: space-around; align-items: center; box-shadow: 0 -2px 8px var(--shadow-color); z-index: 1000; }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: var(--light-text-color); text-decoration: none; flex-grow: 1; padding: 5px 0; transition: all 0.2s; }
        .nav-item.active { color: var(--primary-color); transform: translateY(-3px); }
        .nav-item .icon { font-size: 24px; }
        .nav-item .label { font-size: 12px; margin-top: 2px; font-weight: 500; }
        .page.active { display: block; }
        .page { display: none; }
        .detail-page-header { display: flex; align-items: center; padding: 12px 15px; background-color: var(--card-background); box-shadow: 0 2px 5px var(--shadow-color); }
        .back-button { font-size: 24px; margin-right: 15px; cursor: pointer; }
        .season-buttons { display: flex; gap: 10px; overflow-x: auto; }
        .season-btn { background-color: var(--card-background); color: var(--primary-color); padding: 8px 16px; border-radius: 20px; font-size: 14px; cursor: pointer; border: 1px solid var(--border-color); white-space: nowrap; }
        .season-btn.active { background-color: var(--primary-color); color: white; }
        .parts-list { padding: 20px 15px; }
        .part-item { display: flex; align-items: center; padding: 15px; margin-bottom: 10px; background-color: var(--card-background); border-radius: 10px; box-shadow: 0 2px 4px var(--shadow-color); cursor: pointer; transition: background-color 0.2s, transform 0.2s; }
        .part-item:hover { background-color: #f1f1f1; transform: translateX(5px); }
        .part-poster { width: 100px; height: 75px; border-radius: 8px; object-fit: cover; margin-right: 15px; background-color: #e0e0e0; }
        .part-title { font-size: 16px; font-weight: 500; }
        .loading-spinner { border: 5px solid #f3f3f3; border-top: 5px solid var(--primary-color); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 50px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .empty-message { text-align: center; color: var(--light-text-color); padding: 40px 20px; font-size: 16px; }
    </style>
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
</head>
<body>
    
    <div id="appContainer">
        <div id="moviePage" class="page active">
            <div class="main-content">
                <div class="header">
                    <div class="categories">
                        <div class="category-chip active" data-category="Hollywood">Hollywood</div>
                        <div class="category-chip" data-category="Bollywood">Bollywood</div>
                        <div class="category-chip" data-category="Tollywood">Tollywood</div>
                        <div class="category-chip" data-category="Marathi">Marathi</div>
                        <div class="category-chip" data-category="Korean">Korean</div>
                    </div>
                </div>
                <div class="search-section">
                    <div class="search-container">
                        <input type="text" class="search-bar" placeholder="Search Movies...">
                        <button class="search-button"><i class='bx bx-search'></i></button>
                    </div>
                </div>
                <div id="movie-categories-container"></div>
            </div>
        </div>

        <div id="webseriesPage" class="page">
            <div class="main-content">
                 <div class="header">
                    <div class="categories">
                        <div class="category-chip active" data-category="Trending">Trending</div>
                        <div class="category-chip" data-category="Originals">Originals</div>
                        <div class="category-chip" data-category="Drama">Drama</div>
                        <div class="category-chip" data-category="Crime">Crime</div>
                        <div class="category-chip" data-category="Fantasy">Fantasy</div>
                    </div>
                </div>
                <div class="search-section">
                    <div class="search-container">
                        <input type="text" class="search-bar" placeholder="Search Webseries...">
                        <button class="search-button"><i class='bx bx-search'></i></button>
                    </div>
                </div>
                <div id="webseries-categories-container"></div>
            </div>
        </div>

        <div id="cartoonPage" class="page">
             <div class="main-content">
                 <div class="header">
                    <div class="categories">
                         <div class="category-chip active" data-category="For Kids">For Kids</div>
                        <div class="category-chip" data-category="Anime">Anime</div>
                    </div>
                </div>
                <div class="search-section">
                    <div class="search-container">
                        <input type="text" class="search-bar" placeholder="Search Cartoons...">
                        <button class="search-button"><i class='bx bx-search'></i></button>
                    </div>
                </div>
                <div id="cartoon-categories-container"></div>
            </div>
        </div>

        <div id="profilePage" class="page"><div class="main-content"><h2 style="text-align:center; padding-top: 40px;">Profile Page</h2></div></div>
    
        <nav class="bottom-nav">
            <a href="#movie" class="nav-item active" data-page="moviePage"><i class='bx bxs-movie-play icon'></i><span class="label">Movie</span></a>
            <a href="#webseries" class="nav-item" data-page="webseriesPage"><i class='bx bx-tv icon'></i><span class="label">Webseries</span></a>
            <a href="#cartoon" class="nav-item" data-page="cartoonPage"><i class='bx bxs-smile icon'></i><span class="label">Cartoon</span></a>
            <a href="#profile" class="nav-item" data-page="profilePage"><i class='bx bxs-user-circle icon'></i><span class="label">Profile</span></a>
        </nav>
    </div>

    <div id="detailPage" class="page">
        <div class="detail-page-header">
            <div class="back-button"><i class='bx bx-arrow-back'></i></div>
            <div class="season-buttons"></div>
        </div>
        <div class="parts-list"></div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDuKKz3mlBT8upMd6GZswa7iUB58ZyndGk",
            authDomain: "shubhmovie-b847e.firebaseapp.com",
            databaseURL: "https://shubhmovie-b847e-default-rtdb.firebaseio.com",
            projectId: "shubhmovie-b847e",
            storageBucket: "shubhmovie-b847e.firebasestorage.app",
            messagingSenderId: "598445393451",
            appId: "1:598445393451:web:10be4ecd34d1882a7e0c6e",
            measurementId: "G-4PMYYN12SF"
        };

        const app = initializeApp(firebaseConfig);
        const firestore = getFirestore(app);

        document.addEventListener('DOMContentLoaded', function() {
            const pages = document.querySelectorAll('.page');
            const navItems = document.querySelectorAll('.nav-item');
            const appContainer = document.getElementById('appContainer');
            const detailPage = document.getElementById('detailPage');

            let allMoviesData = null;
            let allWebseriesData = null;
            let allCartoonsData = null;
            
            const genreMap = { 28: "Action & Adventure", 12: "Action & Adventure", 16: "Animated / Anime", 35: "Comedy / Dark Comedy", 80: "Crime", 99: "Documentary", 18: "Romantic Drama", 10751: "Family", 14: "Fantasy / Mythology", 36: "Biopic / Historical Drama", 27: "Horror / Supernatural", 10402: "Music", 9648: "Thriller / Mystery", 10749: "Romantic Drama", 878: "Sci-Fi", 10770: "TV Movie", 53: "Thriller / Mystery", 10752: "War", 37: "Western" };
            const mapGenres = (genreIds) => genreIds.map(id => genreMap[id]).find(g => g) || "Uncategorized";

            async function fetchExternalContent(mediaType) {
                const results = [];
                const type = mediaType === 'movies' ? 'movie' : 'tv';
                const totalPagesToFetch = 15;
                const requests = [];
                for (let i = 1; i <= totalPagesToFetch; i++) {
                    requests.push(fetch(`https://tmdb-proxy.vercel.app/3/discover/${type}?page=${i}&language=hi-IN&with_original_language=hi`).then(res => res.json()));
                    requests.push(fetch(`https://tmdb-proxy.vercel.app/3/discover/${type}?page=${i}`).then(res => res.json()));
                }
                const responses = await Promise.all(requests);
                const titles = new Set();
                for (const data of responses) {
                    if (data.results) {
                        data.results.forEach(item => {
                            const title = item.title || item.name;
                            if (item.poster_path && !titles.has(title)) {
                                titles.add(title);
                                results.push({ id: item.id.toString(), tmdbId: item.id.toString(), title: title, posterUrl: `https://image.tmdb.org/t/p/w500${item.poster_path}`, category: item.original_language === 'hi' ? 'Bollywood' : 'Hollywood', genre: mapGenres(item.genre_ids) });
                            }
                        });
                    }
                }
                return results;
            }

            async function loadInitialData(pageId) {
                const container = document.getElementById(`${pageId}-categories-container`);
                const activeChip = document.querySelector(`#${pageId}Page .category-chip.active`);
                const selectedCategory = activeChip ? activeChip.dataset.category : null;
                let dataVar, collectionName, mediaType;
                if (pageId === 'movie') { dataVar = allMoviesData; collectionName = 'movies'; mediaType = 'movies'; } 
                else if (pageId === 'webseries') { dataVar = allWebseriesData; collectionName = 'webseries'; mediaType = 'webseries'; }
                else { dataVar = allCartoonsData; collectionName = 'cartoons'; mediaType = 'cartoons'; }
                if (dataVar) { displayContentForCategory(pageId, selectedCategory, dataVar); return; }
                container.innerHTML = '<div class="loading-spinner"></div>';
                try {
                    const firestorePromise = getDocs(collection(firestore, collectionName));
                    const externalPromise = mediaType !== 'cartoons' ? fetchExternalContent(mediaType) : Promise.resolve([]);
                    const [firestoreSnapshot, externalItems] = await Promise.all([firestorePromise, externalPromise]);
                    let firestoreItems = [];
                    firestoreSnapshot.forEach(doc => { firestoreItems.push({ id: doc.id, fromFirestore: true, ...doc.data() }); });
                    const firestoreTitles = new Set(firestoreItems.map(item => item.title));
                    const uniqueExternalItems = externalItems.filter(extItem => !firestoreTitles.has(extItem.title));
                    const allItems = [...firestoreItems, ...uniqueExternalItems];
                    if (mediaType === 'movies') allMoviesData = allItems;
                    else if (mediaType === 'webseries') allWebseriesData = allItems;
                    else allCartoonsData = firestoreItems;
                    displayContentForCategory(pageId, selectedCategory, allItems);
                } catch (error) {
                    console.error("Data Loading Error:", error);
                    container.innerHTML = `<div class="empty-message">Failed to load data. Please check your Firestore rules in Firebase Console.</div>`;
                }
            }
            
            function displayContentForCategory(pageId, selectedCategory, allItems) {
                const container = document.getElementById(`${pageId}-categories-container`);
                container.innerHTML = '';
                const itemsInCategory = allItems.filter(item => item.category === selectedCategory);
                if (itemsInCategory.length > 0) {
                    const groupedByGenre = itemsInCategory.reduce((acc, item) => {
                        const genre = item.genre || 'Uncategorized';
                        if (!acc[genre]) acc[genre] = [];
                        acc[genre].push(item);
                        return acc;
                    }, {});
                    const genreOrder = [ "Action & Adventure", "Romantic Drama", "Comedy / Dark Comedy", "Thriller / Mystery", "Sci-Fi", "Horror / Supernatural", "Fantasy / Mythology", "Crime" ];
                    genreOrder.forEach(genre => {
                        if (groupedByGenre[genre]) { renderMediaSection(container, genre, groupedByGenre[genre], pageId.replace('Page', '')); delete groupedByGenre[genre]; }
                    });
                    for (const genre in groupedByGenre) { renderMediaSection(container, genre, groupedByGenre[genre], pageId.replace('Page', '')); }
                }
                if (container.innerHTML === '') { container.innerHTML = `<div class="empty-message">No content found in '${selectedCategory}'.</div>`; }
                addMediaCardListeners();
            }

            function renderMediaSection(container, title, items, mediaType) {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'media-category';
                categoryDiv.innerHTML = `<div class="category-header"><div class="category-title">${title}</div></div><div class="media-scroller"></div>`;
                const scroller = categoryDiv.querySelector('.media-scroller');
                items.forEach(item => {
                    const card = document.createElement('div');
                    card.className = 'media-card';
                    card.dataset.type = mediaType; card.dataset.id = item.id;
                    card.dataset.fromFirestore = item.fromFirestore || false;
                    if (item.megaLink) card.dataset.link = item.megaLink;
                    if (item.tmdbId) card.dataset.tmdbId = item.tmdbId;
                    card.innerHTML = `<img src="${item.posterUrl}" alt="Poster" class="media-poster"><div class="media-title">${item.title}</div>`;
                    scroller.appendChild(card);
                });
                container.appendChild(categoryDiv);
            }

            function addMediaCardListeners() {
                document.querySelectorAll('.media-card').forEach(card => {
                    card.addEventListener('click', async function() {
                        const type = this.dataset.type;
                        const id = this.dataset.id;
                        const fromFirestore = this.dataset.fromFirestore === 'true';
                        const megaLink = this.dataset.link;
                        const tmdbId = this.dataset.tmdbId;

                        if (megaLink) {
                            window.open(megaLink, '_blank');
                        } else if (tmdbId) {
                            const urlType = type === 'movies' ? 'movie' : 'tv';
                            // ########## YEH FINAL AUR WORKING SERVER LINK HAI ##########
                            window.open(`https://moviesapi.club/${urlType}/${tmdbId}`, '_blank');
                            // #########################################################
                        } else if (fromFirestore) {
                             try {
                                const docRef = doc(firestore, type, id);
                                const docSnap = await getDoc(docRef);
                                if (docSnap.exists()) { showDetailPage(docSnap.data()); }
                            } catch (error) { console.error("Error fetching details:", error); }
                        }
                    });
                });
            }
            
            navItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault(); const pageId = this.dataset.page;
                    appContainer.style.display = 'block'; detailPage.classList.remove('active');
                    document.querySelector('.nav-item.active').classList.remove('active');
                    document.querySelector('.page.active').classList.remove('active');
                    this.classList.add('active'); document.getElementById(pageId).classList.add('active');
                    window.scrollTo(0, 0); loadInitialData(pageId.replace('Page', ''));
                });
            });

            document.querySelectorAll('.categories').forEach(catContainer => {
                catContainer.addEventListener('click', (e) => {
                    if (e.target.classList.contains('category-chip')) {
                        const pageId = e.target.closest('.page').id.replace('Page', '');
                        catContainer.querySelector('.active').classList.remove('active');
                        e.target.classList.add('active');
                        let dataToDisplay;
                        if(pageId === 'movie') dataToDisplay = allMoviesData;
                        else if(pageId === 'webseries') dataToDisplay = allWebseriesData;
                        else dataToDisplay = allCartoonsData;
                        displayContentForCategory(pageId, e.target.dataset.category, dataToDisplay);
                    }
                });
            });

            detailPage.querySelector('.back-button').addEventListener('click', () => {
                detailPage.classList.remove('active'); appContainer.style.display = 'block';
            });
            
            function showDetailPage(data) {
                appContainer.style.display = 'none'; detailPage.classList.add('active'); window.scrollTo(0, 0);
                const seasonButtonsContainer = detailPage.querySelector('.season-buttons');
                const partsListContainer = detailPage.querySelector('.parts-list');
                seasonButtonsContainer.innerHTML = ''; partsListContainer.innerHTML = '';
                if (data.seasons) {
                    const seasonKeys = Object.keys(data.seasons).sort((a,b) => parseInt(a) - parseInt(b));
                    seasonKeys.forEach((seasonNum, index) => {
                        const btn = document.createElement('button');
                        btn.className = 'season-btn'; btn.textContent = `Season ${seasonNum}`;
                        if (index === 0) { btn.classList.add('active'); loadParts(data.seasons[seasonNum]); }
                        btn.addEventListener('click', function() {
                            seasonButtonsContainer.querySelector('.active').classList.remove('active');
                            this.classList.add('active'); loadParts(data.seasons[seasonNum]);
                        });
                        seasonButtonsContainer.appendChild(btn);
                    });
                } else { partsListContainer.innerHTML = `<div class="empty-message">No seasons or episodes found.</div>`; }
            }

            function loadParts(parts) {
                const partsListContainer = detailPage.querySelector('.parts-list');
                partsListContainer.innerHTML = '';
                const partKeys = Object.keys(parts).sort((a, b) => a.localeCompare(b, undefined, { numeric: true }));
                partKeys.forEach(partId => {
                    const part = parts[partId]; const item = document.createElement('div');
                    item.className = 'part-item';
                    item.innerHTML = `<img src="${part.posterUrl || 'https://via.placeholder.com/200x150'}" class="part-poster"><div class="part-title">${part.partName}</div>`;
                    item.addEventListener('click', () => { if (part.megaLink) window.open(part.megaLink, '_blank'); });
                    partsListContainer.appendChild(item);
                });
            }

             document.querySelectorAll('.search-button').forEach(searchButton => {
                const searchBar = searchButton.previousElementSibling; const page = searchButton.closest('.page');
                const performSearch = () => {
                    const searchTerm = searchBar.value.toLowerCase().trim();
                    const pageId = page.id.replace('Page', '');
                    const activeChip = page.querySelector('.category-chip.active');
                    const selectedCategory = activeChip ? activeChip.dataset.category : null;
                    let allData;
                    if (pageId === 'movie') allData = allMoviesData;
                    else if (pageId === 'webseries') allData = allWebseriesData;
                    else allData = allCartoonsData;
                    if (searchTerm === '') { displayContentForCategory(pageId, selectedCategory, allData); return; }
                    const searchResults = allData.filter(item => item.title && item.title.toLowerCase().includes(searchTerm));
                    displayContentForCategory(pageId, selectedCategory, searchResults);
                };
                searchBar.addEventListener('keyup', (event) => { if (event.key === 'Enter') performSearch(); });
                searchButton.addEventListener('click', performSearch);
            });

            loadInitialData('movie');
        });
    </script>
</body>
</html>
